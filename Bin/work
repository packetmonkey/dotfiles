#!/usr/bin/env ruby

require 'pathname'

class Project
  def initialize(root_path)
    self.root_path = Pathname.new root_path
  end

  # We check for a few things here.
  #   If we have a Vagrant file, we fire up vagrant
  #   elsif we have a ./script/server file, we start that
  #   elsif we have a Rakefile, we call rake
  #   else We just sit there, I don't know how to spin this application up
  def start_server
    throw :hi
    start_vagrant
  end

  def start_vagrant
    return unless vagrant?
    throw :here
    # tmux send-keys -t ${SESSION_NAME} 'vim' C-m
  end

  def vagrant?
    File.exist? root_path.join('Vagrantfile')
  end

  private

  attr_accessor :root_path
end

def session_name
  @session_name = File.basename(Dir.pwd())
end

def tmux_session_id
  return @tmux_session_id if @tmux_session_id

  tmux_listing = `tmux list-sessions 2>&1`

  return unless $?.success?

  row = tmux_listing.split("\n").find{ |r| r.index(session_name) }

  return unless row

  tmux_session_id = row.split(/: /)[1].split(' ').first
end

# Attach if we are already set up and go from there
exec "tmux attach -t #{session_name}" if tmux_session_id

# We need to start up a new session and set it up correctly
`tmux new-session -s #{session_name}`

p = Project.new Dir.pwd()
p.start_server
